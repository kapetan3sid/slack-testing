name: PR Slack Notify

on:
  pull_request:
    types: [opened, ready_for_review, review_requested, assigned]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm install @slack/web-api
      - name: Notify reviewers via Slack
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: |
          node <<'EOF'
          const { WebClient } = require('@slack/web-api');
          const fs = require('fs');
          
          async function main() {
            try {
              console.log('Starting Slack notification process...');
              
              if (!process.env.SLACK_BOT_TOKEN) {
                console.error('Error: SLACK_BOT_TOKEN environment variable is required');
                process.exit(1);
              }
              
              const mapping = JSON.parse(fs.readFileSync('engineer-github-slack-mapping.json', 'utf8'));
              const slack = new WebClient(process.env.SLACK_BOT_TOKEN);
              
              // Debug: Test bot authentication
              try {
                const authTest = await slack.auth.test();
                console.log('Bot authenticated as:', authTest.user, 'in workspace:', authTest.team);
              } catch (err) {
                console.error('‚ùå Auth test failed:', err.data || err.message);
                return;
              }
              
              // Get event data
              const eventPath = process.env.GITHUB_EVENT_PATH;
              const event = JSON.parse(fs.readFileSync(eventPath, 'utf8'));
              
              console.log('Event action:', event.action);
              console.log('PR URL:', event.pull_request?.html_url);
              
              // The Slack Channel ID you want to post in:
              const CHANNEL_ID = 'C07TXJZ0T3L'; // Your verified channel ID
              
              let targetUsers = [];
              
              // Get reviewers and assignees based on event
              if (event.action === 'review_requested' && event.requested_reviewer) {
                targetUsers.push(event.requested_reviewer.login);
                console.log('Reviewer requested:', event.requested_reviewer.login);
              } else if (event.action === 'assigned' && event.assignee) {
                targetUsers.push(event.assignee.login);
                console.log('Assignee added:', event.assignee.login);
              } else if (event.pull_request) {
                // For opened/ready_for_review, notify all current reviewers and assignees
                if (event.pull_request.requested_reviewers) {
                  targetUsers.push(...event.pull_request.requested_reviewers.map(r => r.login));
                }
                if (event.pull_request.assignees) {
                  targetUsers.push(...event.pull_request.assignees.map(a => a.login));
                }
              }
              
              // Remove duplicates
              targetUsers = [...new Set(targetUsers)];
              console.log('Target users:', targetUsers);
              
              if (targetUsers.length === 0) {
                console.log('No target users found, skipping notifications');
                return;
              }
              
              // Debug: Try multiple channel formats
              const channelOptions = [
                'C07TXJZ0T3L',           // Original ID
                '#general',              // Default channel
                '#random'                // Another common channel
              ];
              
              let successfulChannel = null;
              
              for (const channel of channelOptions) {
                try {
                  console.log(`üîç Testing channel: ${channel}`);
                  const testResult = await slack.chat.postMessage({
                    channel: channel,
                    text: `TEST: Channel ${channel} works! Bot can send here.`
                  });
                  console.log(`‚úÖ SUCCESS with channel: ${channel}`);
                  successfulChannel = channel;
                  break;
                } catch (err) {
                  console.log(`‚ùå FAILED with channel ${channel}:`, err.data?.error || err.message);
                }
              }
              
              if (!successfulChannel) {
                console.error('‚ùå No working channel found! Check bot permissions and channel IDs.');
                return;
              }
              
              console.log(`üì§ Using working channel: ${successfulChannel} for notifications`);
              
              // Send notifications
              for (const username of targetUsers) {
                const engineer = mapping.engineers.find(e => e.github_username === username);
                if (engineer) {
                  try {
                    const result = await slack.chat.postMessage({
                      channel: successfulChannel,
                      text: `Hey <@${engineer.slack_id}>, you have a PR to review: ${event.pull_request.html_url}`
                    });
                    console.log(`‚úÖ Sent to ${username} (${engineer.slack_id}):`, result.ok);
                  } catch (err) {
                    console.error(`‚ùå Error sending to ${username}:`, err.data || err.message);
                  }
                } else {
                  console.log(`‚ö†Ô∏è No Slack mapping found for ${username}`);
                }
              }
            } catch (error) {
              console.error('Script error:', error);
              process.exit(1);
            }
          }
          
          main();
          EOF

